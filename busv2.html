<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>巴士報站模擬器</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            background-color: #f3f4f6; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-top: env(safe-area-inset-top);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .stop-active { border-color: #3b82f6; background-color: #eff6ff; }
        .btn-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-shadow:active { transform: scale(0.97); box-shadow: none; }
        
        .toast { 
            position: fixed; 
            bottom: 160px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.85); 
            color: white; 
            padding: 12px 24px; 
            border-radius: 99px; 
            z-index: 100; 
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 0.3s, transform 0.3s; 
            font-size: 14px;
            font-weight: 600;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        .safe-bottom {
            padding-bottom: calc(env(safe-area-inset-bottom) + 24px);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const BusApp = () => {
            const [routes, setRoutes] = useState(() => {
                const saved = localStorage.getItem('bus_routes');
                return saved ? JSON.parse(saved) : [
                    { id: 1, number: "71B", destination: "大埔中心", color: "bg-red-600", stops: ["歡迎", "大埔中心"] },
                    { id: 2, number: "272K", destination: "大學站", color: "bg-orange-500", stops: ["歡迎", "大學站"] },
                    { id: 3, number: "49X", destination: "廣源", color: "bg-green-600", stops: ["歡迎", "廣源"] },
                    { id: 4, number: "274P", destination: "馬鞍山站", color: "bg-zinc-700", stops: ["歡迎", "馬鞍山站"] },
                    { id: 5, number: "72K", destination: "太和", color: "bg-blue-600", stops: ["歡迎", "太和"] }
                ];
            });

            const [currentView, setCurrentView] = useState('home');
            const [selectedRoute, setSelectedRoute] = useState(null);
            const [currentIndex, setCurrentIndex] = useState(-1);
            const [playing, setPlaying] = useState(false);
            const [customAudio, setCustomAudio] = useState({});
            const [toastMsg, setToastMsg] = useState("");
            const audioRef = useRef(null);
            
            const silentAudioRef = useRef(new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAP8A'));
            silentAudioRef.current.loop = true;

            useEffect(() => {
                localStorage.setItem('bus_routes', JSON.stringify(routes));
            }, [routes]);

            // MediaSession 適配 (Lock Screen 控制)
            useEffect(() => {
                if ('mediaSession' in navigator && selectedRoute) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: `路線 ${selectedRoute.number}`,
                        artist: `下一站：${currentIndex >= 0 ? selectedRoute.stops[currentIndex] : '準備出發'}`,
                        album: `目的地：${selectedRoute.destination}`,
                        artwork: [{ src: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', sizes: '512x512', type: 'image/png' }]
                    });

                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        document.getElementById('main-next-btn')?.click();
                    });
                }
            }, [selectedRoute, currentIndex]);

            const showToast = (msg) => {
                setToastMsg(msg);
                setTimeout(() => setToastMsg(""), 3000);
            };

            const playStop = (index) => {
                if (!selectedRoute || index < 0 || index >= selectedRoute.stops.length) return;
                silentAudioRef.current.play().catch(()=>{});
                window.speechSynthesis.cancel();
                if (audioRef.current) { audioRef.current.pause(); audioRef.current.currentTime = 0; }

                setCurrentIndex(index);
                setPlaying(true);

                const stop = selectedRoute.stops[index];
                const key = `${selectedRoute.id}-${index}`;

                if (customAudio[key]) {
                    const audio = new Audio(customAudio[key]);
                    audioRef.current = audio;
                    audio.onended = () => setPlaying(false);
                    audio.play().catch(() => setPlaying(false));
                } else {
                    const msg = new SpeechSynthesisUtterance(`下一站，${stop}。Next stop, ${stop}.`);
                    msg.lang = 'zh-HK';
                    msg.onend = () => setPlaying(false);
                    window.speechSynthesis.speak(msg);
                }
            };

            const nextStop = () => {
                if (currentIndex < (selectedRoute?.stops.length || 0) - 1) {
                    playStop(currentIndex + 1);
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col overflow-hidden shadow-2xl border-x border-gray-200">
                    <div className={`toast ${toastMsg ? 'show' : ''}`}>{toastMsg}</div>
                    
                    <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-50 pt-10">
                        {currentView === 'home' ? (
                            <h1 className="text-xl font-bold text-gray-800 tracking-tight">巴士報站模擬</h1>
                        ) : (
                            <button onClick={() => { window.speechSynthesis.cancel(); silentAudioRef.current.pause(); setCurrentView('home'); }} className="text-gray-500 p-2">
                                <i className="fas fa-chevron-left text-lg"></i>
                            </button>
                        )}
                        <div className="flex gap-2">
                            {currentView === 'home' && (
                                <button onClick={() => setCurrentView('add')} className="text-blue-600 p-2">
                                    <i className="fas fa-plus-circle text-2xl"></i>
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto px-4 py-4 hide-scrollbar">
                        {currentView === 'home' && (
                            <div className="space-y-4">
                                {routes.map(r => (
                                    <div key={r.id} onClick={() => { setSelectedRoute(r); setCurrentIndex(-1); setCurrentView('route'); }} 
                                         className="bg-white rounded-2xl overflow-hidden cursor-pointer btn-shadow border border-gray-100 transition-transform active:scale-98">
                                        <div className={`${r.color || 'bg-blue-600'} p-4 flex justify-between items-center`}>
                                            <span className="text-4xl font-black text-white italic tracking-tighter">{r.number}</span>
                                            <i className="fas fa-bus text-white/30 text-2xl"></i>
                                        </div>
                                        <div className="p-4 flex justify-between items-center text-gray-800 font-bold">
                                            <div>往 {r.destination}</div>
                                            <button onClick={(e) => { e.stopPropagation(); if(confirm("刪除整條路線？")) setRoutes(routes.filter(x=>x.id!==r.id)); }} className="text-gray-300 hover:text-red-500 p-2"><i className="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                ))}
                                {routes.length === 0 && <div className="text-center py-20 text-gray-400 font-medium">請按右上角新增路線</div>}
                            </div>
                        )}

                        {currentView === 'route' && selectedRoute && (
                            <div className="pb-48">
                                <div className="mb-6 px-2">
                                    <div className="text-5xl font-black text-gray-900 italic leading-none mb-1">{selectedRoute.number}</div>
                                    <div className="text-gray-500 font-bold tracking-tight">往 {selectedRoute.destination}</div>
                                </div>
                                <div className="space-y-3 px-1">
                                    {selectedRoute.stops.map((s, i) => (
                                        <div key={`${selectedRoute.id}-${i}`} className="flex items-center gap-3">
                                            <button 
                                                onClick={() => playStop(i)} 
                                                className={`flex-1 p-4 rounded-xl border-2 text-left flex justify-between items-center transition-all ${currentIndex === i ? 'stop-active border-blue-500 shadow-md scale-[1.02]' : 'bg-white border-gray-100'}`}
                                            >
                                                <span className="font-bold truncate pr-2">{i+1}. {s}</span>
                                                {customAudio[`${selectedRoute.id}-${i}`] && <i className="fas fa-music text-blue-400 text-[10px] ml-1"></i>}
                                                {playing && currentIndex === i && <i className="fas fa-volume-up text-blue-500 animate-pulse"></i>}
                                            </button>
                                            <div className="flex items-center bg-gray-100 rounded-xl">
                                                <label className="p-3 text-gray-400 hover:text-blue-500 cursor-pointer">
                                                    <i className="fas fa-upload text-sm"></i>
                                                    <input type="file" className="hidden" accept="audio/*" onChange={(e) => {
                                                        const file = e.target.files[0];
                                                        if(file) setCustomAudio(prev => ({ ...prev, [`${selectedRoute.id}-${i}`]: URL.createObjectURL(file) }));
                                                    }} />
                                                </label>
                                                <div className="w-[1px] h-4 bg-gray-200"></div>
                                                <button onClick={(e) => { 
                                                    e.stopPropagation(); 
                                                    if(confirm("移除車站？")) {
                                                        const newStops = [...selectedRoute.stops];
                                                        newStops.splice(i, 1);
                                                        const updated = {...selectedRoute, stops: newStops};
                                                        setSelectedRoute(updated);
                                                        setRoutes(routes.map(r => r.id === updated.id ? updated : r));
                                                    }
                                                }} className="p-3 text-gray-400"><i className="fas fa-trash-can text-sm"></i></button>
                                            </div>
                                        </div>
                                    ))}
                                    <button onClick={() => {
                                        const name = prompt("車站名：");
                                        if(name) {
                                            const updated = {...selectedRoute, stops: [...selectedRoute.stops, name]};
                                            setSelectedRoute(updated);
                                            setRoutes(routes.map(r => r.id === updated.id ? updated : r));
                                        }
                                    }} className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold mt-4 active:bg-gray-100 transition-colors">+ 新增車站</button>
                                </div>
                            </div>
                        )}

                        {currentView === 'add' && (
                           <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-4">
                               <h2 className="font-bold text-gray-800">新增路線</h2>
                               <input id="n" type="text" placeholder="路線號碼 (例: 118)" className="w-full bg-gray-50 border p-4 rounded-xl outline-none focus:border-blue-500" />
                               <input id="d" type="text" placeholder="目的地" className="w-full bg-gray-50 border p-4 rounded-xl outline-none focus:border-blue-500" />
                               <textarea id="s" placeholder="車站名稱 (逗號隔開)" className="w-full bg-gray-50 border p-4 rounded-xl outline-none focus:border-blue-500" rows="5"></textarea>
                               <button className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl btn-shadow" onClick={() => {
                                   const n = document.getElementById('n').value;
                                   const d = document.getElementById('d').value;
                                   const s = document.getElementById('s').value;
                                   if(n && d && s) {
                                       setRoutes([...routes, { id: Date.now(), number: n, destination: d, color: 'bg-zinc-700', stops: s.split(/[,，]/).map(x => x.trim()) }]);
                                       setCurrentView('home');
                                   }
                               }}>確認儲存</button>
                           </div>
                        )}
                    </main>

                    {currentView === 'route' && (
                        <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-md border-t border-gray-200 safe-bottom z-[60]">
                            <div className="px-6 pt-4">
                                <button 
                                    id="main-next-btn"
                                    onClick={nextStop} 
                                    className="w-full py-5 bg-blue-600 text-white rounded-2xl flex items-center justify-center gap-3 btn-shadow active:bg-blue-700 transition-all"
                                >
                                    <span className="text-xl font-bold uppercase tracking-wider italic">Next Stop</span>
                                    <i className="fas fa-forward"></i>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BusApp />);
    </script>
</body>
</html>